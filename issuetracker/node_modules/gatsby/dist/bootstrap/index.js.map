{"version":3,"sources":["../../src/bootstrap/index.js"],"names":["_","require","slash","fs","md5File","crypto","del","path","Promise","telemetry","apiRunnerNode","getBrowserslist","store","emitter","loadPlugins","loadThemes","report","getConfigFile","tracer","globalTracer","preferDefault","nodeTracking","process","on","reason","p","panic","createGraphqlRunner","extractQueries","requiresWriter","writeRedirects","module","exports","args","spanArgs","parentSpan","childOf","bootstrapSpan","startSpan","directory","program","browserslist","dispatch","type","payload","activity","activityTimer","start","config","__experimentalThemes","themes","useLegacyThemes","plugins","polyfill","warn","end","flattenedPlugins","decorateEvent","map","name","version","span","env","NODE_ENV","pluginVersions","hashes","all","resolve","catch","pluginsHash","createHash","update","JSON","stringify","concat","digest","state","getState","oldPluginsHash","status","PLUGINS_HASH","info","stripIndent","cacheDirectory","remove","emptyDir","e","error","ensureDir","GATSBY_DB_NODES","loki","dbSaveFile","saveFile","dirname","trackDbNodes","srcDir","__dirname","siteDir","tryRequire","copy","clobber","ensureDirSync","err","hasAPIFile","plugin","skipSSR","undefined","envAPIs","join","Array","isArray","length","ssrPlugins","filter","options","pluginOptions","browserPlugins","browserPluginsRequires","browserAPIRunner","sSRAPIRunner","readFileSync","ssrPluginsRequires","writeFileSync","build","extensions","apiResults","traceId","flattenDeep","graphqlRunner","graphql","waitForCascadingActions","rebuildWithSitePage","writeAll","log","uptime","toFixed","emit","boundActionCreators","setProgramStatus","finish"],"mappings":"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","sourcesContent":["/* @flow */\n\nconst _ = require(`lodash`)\nconst slash = require(`slash`)\nconst fs = require(`fs-extra`)\nconst md5File = require(`md5-file/promise`)\nconst crypto = require(`crypto`)\nconst del = require(`del`)\nconst path = require(`path`)\nconst Promise = require(`bluebird`)\nconst telemetry = require(`gatsby-telemetry`)\n\nconst apiRunnerNode = require(`../utils/api-runner-node`)\nconst getBrowserslist = require(`../utils/browserslist`)\nconst { store, emitter } = require(`../redux`)\nconst loadPlugins = require(`./load-plugins`)\nconst loadThemes = require(`./load-themes`)\nconst report = require(`gatsby-cli/lib/reporter`)\nconst getConfigFile = require(`./get-config-file`)\nconst tracer = require(`opentracing`).globalTracer()\nconst preferDefault = require(`./prefer-default`)\nconst nodeTracking = require(`../db/node-tracking`)\n// Add `util.promisify` polyfill for old node versions\nrequire(`util.promisify/shim`)()\n\n// Show stack trace on unhandled promises.\nprocess.on(`unhandledRejection`, (reason, p) => {\n  report.panic(reason)\n})\n\nconst createGraphqlRunner = require(`./graphql-runner`)\nconst { extractQueries } = require(`../query/query-watcher`)\nconst requiresWriter = require(`./requires-writer`)\nconst { writeRedirects } = require(`./redirects-writer`)\n\n// Override console.log to add the source file + line number.\n// Useful for debugging if you lose a console.log somewhere.\n// Otherwise leave commented out.\n// require(`./log-line-function`)\n\ntype BootstrapArgs = {\n  directory: string,\n  prefixPaths?: boolean,\n  parentSpan: Object,\n}\n\nmodule.exports = async (args: BootstrapArgs) => {\n  const spanArgs = args.parentSpan ? { childOf: args.parentSpan } : {}\n  const bootstrapSpan = tracer.startSpan(`bootstrap`, spanArgs)\n\n  // Start plugin runner which listens to the store\n  // and invokes Gatsby API based on actions.\n  require(`../redux/plugin-runner`)\n\n  const directory = slash(args.directory)\n\n  const program = {\n    ...args,\n    browserslist: getBrowserslist(directory),\n    // Fix program directory path for windows env.\n    directory,\n  }\n\n  store.dispatch({\n    type: `SET_PROGRAM`,\n    payload: program,\n  })\n\n  // Try opening the site's gatsby-config.js file.\n  let activity = report.activityTimer(`open and validate gatsby-configs`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  let config = await preferDefault(\n    getConfigFile(program.directory, `gatsby-config`)\n  )\n\n  // theme gatsby configs can be functions or objects\n  if (config && config.__experimentalThemes) {\n    // TODO: deprecation message for old __experimentalThemes\n    const themes = await loadThemes(config, { useLegacyThemes: true })\n    config = themes.config\n\n    store.dispatch({\n      type: `SET_RESOLVED_THEMES`,\n      payload: themes.themes,\n    })\n  } else if (config) {\n    const plugins = await loadThemes(config, { useLegacyThemes: false })\n    config = plugins.config\n  }\n\n  if (config && config.polyfill) {\n    report.warn(\n      `Support for custom Promise polyfills has been removed in Gatsby v2. We only support Babel 7's new automatic polyfilling behavior.`\n    )\n  }\n\n  store.dispatch({\n    type: `SET_SITE_CONFIG`,\n    payload: config,\n  })\n\n  activity.end()\n\n  activity = report.activityTimer(`load plugins`)\n  activity.start()\n  const flattenedPlugins = await loadPlugins(config, program.directory)\n  activity.end()\n\n  telemetry.decorateEvent(`BUILD_END`, {\n    plugins: flattenedPlugins.map(p => `${p.name}@${p.version}`),\n  })\n\n  // onPreInit\n  activity = report.activityTimer(`onPreInit`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await apiRunnerNode(`onPreInit`, { parentSpan: activity.span })\n  activity.end()\n\n  // During builds, delete html and css files from the public directory as we don't want\n  // deleted pages and styles from previous builds to stick around.\n  if (process.env.NODE_ENV === `production`) {\n    activity = report.activityTimer(\n      `delete html and css files from previous builds`,\n      {\n        parentSpan: bootstrapSpan,\n      }\n    )\n    activity.start()\n    await del([\n      `public/*.{html,css}`,\n      `public/**/*.{html,css}`,\n      `!public/static`,\n      `!public/static/**/*.{html,css}`,\n    ])\n    activity.end()\n  }\n\n  activity = report.activityTimer(`initialize cache`)\n  activity.start()\n  // Check if any plugins have been updated since our last run. If so\n  // we delete the cache is there's likely been changes\n  // since the previous run.\n  //\n  // We do this by creating a hash of all the version numbers of installed\n  // plugins, the site's package.json, gatsby-config.js, and gatsby-node.js.\n  // The last, gatsby-node.js, is important as many gatsby sites put important\n  // logic in there e.g. generating slugs for custom pages.\n  const pluginVersions = flattenedPlugins.map(p => p.version)\n  const hashes = await Promise.all([\n    md5File(`package.json`),\n    Promise.resolve(\n      md5File(`${program.directory}/gatsby-config.js`).catch(() => {})\n    ), // ignore as this file isn't required),\n    Promise.resolve(\n      md5File(`${program.directory}/gatsby-node.js`).catch(() => {})\n    ), // ignore as this file isn't required),\n  ])\n  const pluginsHash = crypto\n    .createHash(`md5`)\n    .update(JSON.stringify(pluginVersions.concat(hashes)))\n    .digest(`hex`)\n  let state = store.getState()\n  const oldPluginsHash = state && state.status ? state.status.PLUGINS_HASH : ``\n\n  // Check if anything has changed. If it has, delete the site's .cache\n  // directory and tell reducers to empty themselves.\n  //\n  // Also if the hash isn't there, then delete things just in case something\n  // is weird.\n  if (oldPluginsHash && pluginsHash !== oldPluginsHash) {\n    report.info(report.stripIndent`\n      One or more of your plugins have changed since the last time you ran Gatsby. As\n      a precaution, we're deleting your site's cache to ensure there's not any stale\n      data\n    `)\n  }\n  const cacheDirectory = `${program.directory}/.cache`\n  if (!oldPluginsHash || pluginsHash !== oldPluginsHash) {\n    try {\n      // Attempt to empty dir if remove fails,\n      // like when directory is mount point\n      await fs.remove(cacheDirectory).catch(() => fs.emptyDir(cacheDirectory))\n    } catch (e) {\n      report.error(`Failed to remove .cache files.`, e)\n    }\n    // Tell reducers to delete their data (the store will already have\n    // been loaded from the file system cache).\n    store.dispatch({\n      type: `DELETE_CACHE`,\n    })\n  }\n\n  // Update the store with the new plugins hash.\n  store.dispatch({\n    type: `UPDATE_PLUGINS_HASH`,\n    payload: pluginsHash,\n  })\n\n  // Now that we know the .cache directory is safe, initialize the cache\n  // directory.\n  await fs.ensureDir(cacheDirectory)\n\n  // Ensure the public/static directory\n  await fs.ensureDir(`${program.directory}/public/static`)\n\n  activity.end()\n\n  if (process.env.GATSBY_DB_NODES === `loki`) {\n    const loki = require(`../db/loki`)\n    // Start the nodes database (in memory loki js with interval disk\n    // saves). If data was saved from a previous build, it will be\n    // loaded here\n    activity = report.activityTimer(`start nodes db`, {\n      parentSpan: bootstrapSpan,\n    })\n    activity.start()\n    const dbSaveFile = `${cacheDirectory}/loki/loki.db`\n    try {\n      await loki.start({\n        saveFile: dbSaveFile,\n      })\n    } catch (e) {\n      report.error(\n        `Error starting DB. Perhaps try deleting ${path.dirname(dbSaveFile)}`\n      )\n    }\n    activity.end()\n  }\n\n  // By now, our nodes database has been loaded, so ensure that we\n  // have tracked all inline objects\n  nodeTracking.trackDbNodes()\n\n  // Copy our site files to the root of the site.\n  activity = report.activityTimer(`copy gatsby files`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  const srcDir = `${__dirname}/../../cache-dir`\n  const siteDir = cacheDirectory\n  const tryRequire = `${__dirname}/../utils/test-require-error.js`\n  try {\n    await fs.copy(srcDir, siteDir, {\n      clobber: true,\n    })\n    await fs.copy(tryRequire, `${siteDir}/test-require-error.js`, {\n      clobber: true,\n    })\n    await fs.ensureDirSync(`${cacheDirectory}/json`)\n\n    // Ensure .cache/fragments exists and is empty. We want fragments to be\n    // added on every run in response to data as fragments can only be added if\n    // the data used to create the schema they're dependent on is available.\n    await fs.emptyDir(`${cacheDirectory}/fragments`)\n  } catch (err) {\n    report.panic(`Unable to copy site files to .cache`, err)\n  }\n\n  // Find plugins which implement gatsby-browser and gatsby-ssr and write\n  // out api-runners for them.\n  const hasAPIFile = (env, plugin) => {\n    // The plugin loader has disabled SSR APIs for this plugin. Usually due to\n    // multiple implementations of an API that can only be implemented once\n    if (env === `ssr` && plugin.skipSSR === true) return undefined\n\n    const envAPIs = plugin[`${env}APIs`]\n\n    // Always include gatsby-browser.js files if they exists as they're\n    // a handy place to include global styles and other global imports.\n    try {\n      if (env === `browser`) {\n        return slash(\n          require.resolve(path.join(plugin.resolve, `gatsby-${env}`))\n        )\n      }\n    } catch (e) {\n      // ignore\n    }\n\n    if (envAPIs && Array.isArray(envAPIs) && envAPIs.length > 0) {\n      return slash(path.join(plugin.resolve, `gatsby-${env}`))\n    }\n    return undefined\n  }\n\n  const ssrPlugins = _.filter(\n    flattenedPlugins.map(plugin => {\n      return {\n        resolve: hasAPIFile(`ssr`, plugin),\n        options: plugin.pluginOptions,\n      }\n    }),\n    plugin => plugin.resolve\n  )\n\n  const browserPlugins = _.filter(\n    flattenedPlugins.map(plugin => {\n      return {\n        resolve: hasAPIFile(`browser`, plugin),\n        options: plugin.pluginOptions,\n      }\n    }),\n    plugin => plugin.resolve\n  )\n\n  const browserPluginsRequires = browserPlugins\n    .map(\n      plugin =>\n        `{\n      plugin: require('${plugin.resolve}'),\n      options: ${JSON.stringify(plugin.options)},\n    }`\n    )\n    .join(`,`)\n\n  const browserAPIRunner = `module.exports = [${browserPluginsRequires}]\\n`\n\n  let sSRAPIRunner = ``\n\n  try {\n    sSRAPIRunner = fs.readFileSync(`${siteDir}/api-runner-ssr.js`, `utf-8`)\n  } catch (err) {\n    report.panic(`Failed to read ${siteDir}/api-runner-ssr.js`, err)\n  }\n\n  const ssrPluginsRequires = ssrPlugins\n    .map(\n      plugin =>\n        `{\n      plugin: require('${plugin.resolve}'),\n      options: ${JSON.stringify(plugin.options)},\n    }`\n    )\n    .join(`,`)\n  sSRAPIRunner = `var plugins = [${ssrPluginsRequires}]\\n${sSRAPIRunner}`\n\n  fs.writeFileSync(\n    `${siteDir}/api-runner-browser-plugins.js`,\n    browserAPIRunner,\n    `utf-8`\n  )\n  fs.writeFileSync(`${siteDir}/api-runner-ssr.js`, sSRAPIRunner, `utf-8`)\n\n  activity.end()\n  /**\n   * Start the main bootstrap processes.\n   */\n\n  // onPreBootstrap\n  activity = report.activityTimer(`onPreBootstrap`)\n  activity.start()\n  await apiRunnerNode(`onPreBootstrap`)\n  activity.end()\n\n  // Source nodes\n  activity = report.activityTimer(`source and transform nodes`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await require(`../utils/source-nodes`)({ parentSpan: activity.span })\n  activity.end()\n\n  // Create Schema.\n  activity = report.activityTimer(`building schema`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await require(`../schema`).build({ parentSpan: activity.span })\n  activity.end()\n\n  // Collect resolvable extensions and attach to program.\n  const extensions = [`.mjs`, `.js`, `.jsx`, `.wasm`, `.json`]\n  // Change to this being an action and plugins implement `onPreBootstrap`\n  // for adding extensions.\n  const apiResults = await apiRunnerNode(`resolvableExtensions`, {\n    traceId: `initial-resolvableExtensions`,\n    parentSpan: bootstrapSpan,\n  })\n\n  store.dispatch({\n    type: `SET_PROGRAM_EXTENSIONS`,\n    payload: _.flattenDeep([extensions, apiResults]),\n  })\n\n  const graphqlRunner = createGraphqlRunner(store, report)\n\n  // Collect pages.\n  activity = report.activityTimer(`createPages`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await apiRunnerNode(`createPages`, {\n    graphql: graphqlRunner,\n    traceId: `initial-createPages`,\n    waitForCascadingActions: true,\n    parentSpan: activity.span,\n  })\n  activity.end()\n\n  // A variant on createPages for plugins that want to\n  // have full control over adding/removing pages. The normal\n  // \"createPages\" API is called every time (during development)\n  // that data changes.\n  activity = report.activityTimer(`createPagesStatefully`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await apiRunnerNode(`createPagesStatefully`, {\n    graphql: graphqlRunner,\n    traceId: `initial-createPagesStatefully`,\n    waitForCascadingActions: true,\n    parentSpan: activity.span,\n  })\n  activity.end()\n\n  activity = report.activityTimer(`onPreExtractQueries`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await apiRunnerNode(`onPreExtractQueries`, { parentSpan: activity.span })\n  activity.end()\n\n  // Update Schema for SitePage.\n  activity = report.activityTimer(`update schema`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await require(`../schema`).rebuildWithSitePage({ parentSpan: activity.span })\n  activity.end()\n\n  // Extract queries\n  activity = report.activityTimer(`extract queries from components`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await extractQueries()\n  activity.end()\n\n  // Write out files.\n  activity = report.activityTimer(`write out requires`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  try {\n    await requiresWriter.writeAll(store.getState())\n  } catch (err) {\n    report.panic(`Failed to write out requires`, err)\n  }\n  activity.end()\n\n  // Write out redirects.\n  activity = report.activityTimer(`write out redirect data`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await writeRedirects()\n  activity.end()\n\n  activity = report.activityTimer(`onPostBootstrap`, {\n    parentSpan: bootstrapSpan,\n  })\n  activity.start()\n  await apiRunnerNode(`onPostBootstrap`, { parentSpan: activity.span })\n  activity.end()\n\n  report.log(``)\n  report.info(`bootstrap finished - ${process.uptime().toFixed(3)} s`)\n  report.log(``)\n  emitter.emit(`BOOTSTRAP_FINISHED`)\n  require(`../redux/actions`).boundActionCreators.setProgramStatus(\n    `BOOTSTRAP_FINISHED`\n  )\n\n  bootstrapSpan.finish()\n\n  return { graphqlRunner }\n}\n"],"file":"index.js"}